<!DOCTYPE html>
<html>

<head>
  <title>Isuzu Web Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script crossorigin="anonymous" src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <script type="text/javascript" src="https://alcdn.msauth.net/lib/1.2.0/js/msal.js"></script>
  <script src="https://unpkg.com/@azure/storage-blob@10.3.0/browser/azure-storage.blob.min.js"
    integrity="sha384-fsfhtLyVQo3L3Bh73qgQoRR328xEeXnRGdoi53kjo1uectCfAHFfavrBBN2Nkbdf"
    crossorigin="anonymous"></script>
  <script type="text/javascript">
    if (typeof Msal === 'undefined') document.write(unescape("%3Cscript src='https://alcdn.msftauth.net/lib/1.2.0/js/msal.js' type='text/javascript' %3E%3C/script%3E"));
  </script>
  <script>
    var clientApplication;
    (function () {
      var msalConfig = {
        auth: {
          clientId: 'de964867-b3fb-4a2f-8707-af06876a5d2c',
          authority: 'https://login.microsoftonline.com/8eafaa3d-7204-4e17-b817-17a294850883'
        },
        cache: {
          cacheLocation: 'localStorage',
          storeAuthStateInCookie: false
        }
      };
      if (!clientApplication) {
        clientApplication = new Msal.UserAgentApplication(msalConfig);
      }
    }());
  </script>

  <style>
    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
    }

    #heading {
      background-color: black;
      height: 50px;
    }

    .main {
      margin: 18px;
      border-radius: 4px;
    }

    div[role="form"] {
      background-color: black;
    }

    #webchat {
      position: fixed;
      height: calc(100% - 90px);
      /* Adjusted for better spacing */
      width: 100%;
      top: 90px;
      overflow: hidden;
    }

    #heading {
      background-color: black;
      background-repeat: no-repeat;
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      height: 50px;
      width: 100%;
      overflow: hidden;
      position: fixed;
      top: 0;
      z-index: 1000;
    }

    h1 {
      font-size: 14px;
      font-family: Segoe UI;
      font-weight: 600;
      line-height: 20px;
      color: #F3F2F1;
      letter-spacing: 0.005em;
      display: table-cell;
      vertical-align: middle;
      padding: 13px 0px 0px 20px;
      margin: 0;
    }

    #chatwindow {
      height: 100%;
      width: 100%;
      position: fixed;
      top: 0;
    }

    #auth-bar {
      position: fixed;
      top: 50px;
      width: 100%;
      background: #f3f2f1;
      padding: 10px;
      z-index: 999;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    #login {
      float: right;
      background-color: #0078d4;
      color: white;
      border: none;
      padding: 5px 15px;
      border-radius: 2px;
      cursor: pointer;
    }

    #login:hover {
      background-color: #106ebe;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      font-family: Segoe UI;
      color: #605e5c;
    }
  </style>

</head>

<body onload="initApp()">
  <div id="chatwindow">
    <div id="heading">
      <h1>SSO Test Bot</h1>
    </div>
    <div id="auth-bar">
      <label id="userName">Not logged in.</label>
      <button id="login" onclick="onSignInClick()">Log In</button>
    </div>
    <div id="webchat">
      <div class="loading">Loading chat interface...</div>
    </div>
  </div>

  <script>
    // Global variables
    let directLine;
    let userId;

    function updateUI(user) {
      const userNameElement = document.getElementById("userName");
      const loginButton = document.getElementById("login");

      if (user) {
        userNameElement.innerHTML = "Logged in as: " + user.name;
        loginButton.style.display = "none";
      } else {
        userNameElement.innerHTML = "Not logged in.";
        loginButton.style.display = "block";
      }
    }

    function onSignin() {
      const user = clientApplication.getAccount();
      updateUI(user);
      initializeWebChat();
    }

    function onSignInClick() {
      const requestObj = {
        scopes: ["User.Read", "openid", "profile", "Sites.Read.All", "Files.Read.All"]
      };

      document.getElementById("webchat").innerHTML = '<div class="loading">Authenticating...</div>';

      clientApplication.loginPopup(requestObj)
        .then(onSignin)
        .catch(error => {
          console.error("Login failed:", error);
          document.getElementById("userName").innerHTML = "Login failed. Please try again.";
          document.getElementById("webchat").innerHTML = '<div class="loading">Please log in to continue.</div>';
        });
    }

    function getOAuthCardResourceUri(activity) {
      if (activity &&
        activity.attachments &&
        activity.attachments[0] &&
        activity.attachments[0].contentType === 'application/vnd.microsoft.card.oauth' &&
        activity.attachments[0].content.tokenExchangeResource) {
        return activity.attachments[0].content.tokenExchangeResource.uri;
      }
    }

    function exchangeTokenAsync(resourceUri) {
      const user = clientApplication.getAccount();
      if (user) {
        const requestObj = { scopes: [resourceUri] };
        return clientApplication.acquireTokenSilent(requestObj)
          .then(tokenResponse => tokenResponse.accessToken)
          .catch(error => {
            console.error("Token acquisition failed:", error);
            return null;
          });
      }
      return Promise.resolve(null);
    }

    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, {
        ...options,
        headers: {
          ...options.headers,
          accept: 'application/json'
        }
      });

      if (!res.ok) {
        throw new Error(`Failed to fetch JSON: ${res.status}`);
      }

      return await res.json();
    }

    async function initializeWebChat() {
      try {
        const user = clientApplication.getAccount();
        if (!user) {
          document.getElementById("webchat").innerHTML = '<div class="loading">Please log in to continue.</div>';
          return;
        }

        document.getElementById("webchat").innerHTML = '<div class="loading">Connecting to bot...</div>';

        userId = user.accountIdentifier ?
          ("usr-" + user.accountIdentifier).substr(0, 64) :
          (Math.random().toString() + Date.now().toString()).substr(0, 64);

        const theURL = "https://default8eafaa3d72044e17b81717a2948508.83.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr405_drFredOnWeb/directline/token?api-version=2022-03-01-preview";

        const { token } = await fetchJSON(theURL);

        // Initialize DirectLine with European endpoint
        directLine = window.WebChat.createDirectLine({
          token,
          domain: 'https://europe.directline.botframework.com/v3/directline'
        });

        const store = WebChat.createStore({}, ({ dispatch }) => next => action => {
          if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
            dispatch({
              type: 'WEB_CHAT/SEND_EVENT',
              payload: {
                name: 'startConversation',
                type: 'event',
                value: { text: user.name }
              }
            });
          }

          if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
            const activity = action.payload.activity;
            const resourceUri = getOAuthCardResourceUri(activity);

            if (activity.from?.role === 'bot' && resourceUri) {
              exchangeTokenAsync(resourceUri).then(token => {
                if (token) {
                  directLine.postActivity({
                    type: 'invoke',
                    name: 'signin/tokenExchange',
                    value: {
                      id: activity.attachments[0].content.tokenExchangeResource.id,
                      connectionName: activity.attachments[0].content.connectionName,
                      token
                    },
                    from: {
                      id: userId,
                      name: user.name,
                      role: "user"
                    }
                  }).subscribe(
                    id => id === 'retry' ? next(action) : null,
                    error => next(action)
                  );
                  return;
                }
                return next(action);
              });
              return;
            }
          }
          return next(action);
        });

        const styleOptions = {
          hideUploadButton: true,
          bubbleBackground: 'rgba(0, 120, 212, 0.1)',
          bubbleFromUserBackground: 'rgba(0, 120, 212, 0.3)'
        };

        window.WebChat.renderWebChat(
          {
            directLine,
            store,
            userID: userId,
            styleOptions
          },
          document.getElementById('webchat')
        );

      } catch (error) {
        console.error("Bot initialization failed:", error);
        document.getElementById("webchat").innerHTML = `
          <div class="loading">
            Failed to connect to bot. Please refresh the page or try again later.
          </div>
        `;
      }
    }

    function initApp() {
      const user = clientApplication.getAccount();
      updateUI(user);
      if (user) {
        initializeWebChat();
      }
    }
  </script>
</body>

</html>